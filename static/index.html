<!DOCTYPE html>
<html>
  <head>
    <title>Completed Hikes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel='stylesheet' href='style.css' />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
      integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
      integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
      crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"
      integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg="
      crossorigin="anonymous"></script>
  </head>
  <body>
    <h1>Completed Hikes</h1>
    <div id="map-container" height="0"></div>

    <script>
      var preferredUnit = 'mi';

      var debug = console.log;
      debug = function(){};

      var convertToPreferredUnit = function(meters){
        switch (preferredUnit) {
          case 'KM':
            return (meters/1000).toFixed(2) + 'KM';
          case 'mi':
            return (meters*0.00062137).toFixed(2) + 'mi';
          default:
            return meters + 'M';
        }
      };

      var getDistance = function(coordinates){
        var degToRad = function(deg){
          return deg * (Math.PI/180);
        };
        var distInMeters = 0;
        for (var i = 1; i < coordinates.length; i++){
          var lat1 = coordinates[i-1][1];
          var lon1 = coordinates[i-1][0];
          var lat2 = coordinates[i][1];
          var lon2 = coordinates[i][0];
          var p1 = degToRad(lat1), p2 = degToRad(lat2), dl = degToRad(lon2-lon1), R = 6371e3; // gives d in metres
          var d = Math.acos( Math.sin(p1)*Math.sin(p2) + Math.cos(p1)*Math.cos(p2) * Math.cos(dl) ) * R;
          distInMeters += !d? 0 : d;
        }
        return distInMeters;
      };

      var randomColor = function(){
        var randomInteger = function(min,max){
          return Math.floor(Math.random() * (max-min+1))+min;
        };
        var hue = randomInteger(210,390)%360;
        var sat = randomInteger(45,95);
        var lum = randomInteger(40,60);
        return 'hsl(' + hue + ',' + sat + '%,' + lum + '%)';
      };

      window.totalDistance = 0;

      var initMap = function(center, zoom){
        debug('resizing container');
        $('#map-container').height($(window).height() - $('#map-container').position().top);

        debug('initializing map');
        var myMap = L.map('map-container').setView(center, zoom);
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
          attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
          maxZoom: 18,
          id: 'mapbox/outdoors-v11',
          tileSize: 512,
          zoomOffset: -1,
          accessToken: 'pk.eyJ1IjoiZGFsbGFzZXBwZXJzb24iLCJhIjoiY2p1YnlobnVwMDE4cDQzbXFyajZsbDV2biJ9.NFl_bu3i-2CpSVoevhmzsw'
        }).addTo(myMap);
        window.backpackingLayerGroup = L.layerGroup();
        var overlays = {
          "Backpacking": window.backpackingLayerGroup
        };
        L.control.layers(null, overlays).addTo(myMap);
        L.control.scale().addTo(myMap);
        window.backpackingLayerGroup.addTo(myMap);
      };

      var renderHikes = function(data){
        debug('adding backpacking layer group');
        for (const hike of data){
          hike.distance = getDistance(hike.features[0].geometry.coordinates);
          if(hike.outAndBack) hike.distance*=2;
          window.totalDistance+=hike.distance;
          var trailLayer = L.geoJSON(hike, {color: randomColor()});
          trailLayer.bindPopup(`<b>${hike.hikeName}</b><br/>${hike.hikeDate}<br/>${convertToPreferredUnit(hike.distance)}${hike.outAndBack?' (Out and Back)':''}`);
          debug('adding trail to backpacking layer group');
          window.backpackingLayerGroup.addLayer(trailLayer);
        }
      };

      $(function(){
        initMap([35.61, -82.4757], 10);
      });

      $.getJSON('hikes.json', renderHikes);
    </script>
  </body>
</html>
